---
title: "Notes on Building Tidy Tools"
author: "Kelly Sovacool"
date: "27-28 Jan. 2020"
output:
  html_document:
    toc: true
    toc_float: true
---
```{r render, eval=FALSE, echo=FALSE}
rmarkdown::render('notes.Rmd', output_dir="docs")
```

Taught by Charlotte & Hadley Wickham at `rstudio::conf(2020)`.

- Repo with workshop materials: [https://github.com/rstudio-conf-2020/build-tidy-tools](https://github.com/rstudio-conf-2020/build-tidy-tools)
- [RStudio Community Thread](https://community.rstudio.com/t/building-tidy-tools-workshop-rstudio-conf-2020/49091)
- 2nd edition of Hadley's [R Packages book](https://r-pkgs.org/index.html)

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval=FALSE)
```

## Libraries & Packages

```{r}
.Library
.libPaths()
```
```{r before_lib}
data.frame(env=search(), path=searchpaths())
```
```{r after_lib}
library(dplyr)
data.frame(env=search(), path=searchpaths())
```

## R setup stuff to make your life easier

### Open .Rprofile
```{r}
usethis::edit_r_profile()
```

### Require devtools in your .Rprofile
```{r}
usethis::use_devtools()
usethis::use_partial_warnings()
```

### Tell usethis about yourself

In your .Rprofile:

```{r who}
options(
  usethis.full_name = "Jane Doe",
  usethis.protocol  = "ssh",
  usethis.description = list(
    `Authors@R` = 'person("Jane", "Doe", email = "jane@example.com", role = c("aut", "cre"), 
    comment = c(ORCID = "YOUR-ORCID-ID"))',
    Version = "0.0.0.9000"
  )
)
```

See [`usethis` setup docs](https://usethis.r-lib.org/articles/articles/usethis-setup.html)

### Restart R completely fresh with an empty environment OFTEN

Options in global settings:
- Don't Restore `.RData` at startup
- Don't save your workspace on exit

Better for reproducibility. 
[Also prevents fires!](https://twitter.com/hadleywickham/status/940021008764846080)

### My .Rprofile now looks like this:

```{r Rprofile}
if (interactive()) {
    suppressMessages(require(devtools))
    suppressMessages(require(testthat))
}
options(
    warnPartialMatchArgs = TRUE,
    warnPartialMatchDollar = TRUE,
    warnPartialMatchAttr = TRUE
)
options(
    usethis.full_name = "Kelly L. Sovacool",
    usethis.protocol  = "ssh",
    usethis.description = list(
        `Authors@R` = 'person("Kelly", "Sovacool", email = "sovacool@umich.edu", role = c("aut", "cre"),
    comment = c(ORCID = "0000-0003-3283-829X"))',
        Version = "0.0.0.9000"
    )
)
```

### sitrep functions

#### project sitrep
```{r}
usethis::proj_sitrep()
```

#### Add `.RData` & `.DS_Store` to `.gitignore`
```{r}
usethis::git_vaccinate() 
```

#### git sitrep
```{r}
usethis::git_sitrep()
```

## What bulding a package looks like from start to finish

["The Whole Game"](https://r-pkgs.org/whole-game.html)

### Create a new, empty package
```{r create_package}
usethis::create_package("~/Desktop/foofactors")
```

This opened the `foofactors` project in a new R session (switch there now).

### Make it a git repo 
```{r git_init}
usethis::use_git()
```

Let's create a new function called `fbind`.

### Create a new R file 
```{r}
usethis::use_r("fbind")
```

In `R/fbind.R`:
```{r}
fbind <- function(a, b) {
  factor(c(as.character(a), as.character(b)))
}
```
### Load the functions in the package

(not quite like installing the package)
```{r load}
devtools::load_all()
```

Keyboard shortcut: `Cmd + Shift + L`

### devtools::check() is like R CMD CHECK

Checks that the package follows all of the proper conventions.
```{r check}
devtools::check()
```

If you have 0 warnings, 0 errors, and 0 notes, everything is great!
But that's not likely to happen the first time you run `check()`.

### Document your function

Rstudio helper: `Code > Insert roxygen skeleton`

#### Then build the documentation

```{r document}
devtools::document()
```

#### Let's add a license too

```{r license}
usethis::use_mit_license()
```

`LICENSE.md` is for GitHub, `LICENSE` (no extension) is for CRAN.

Let's `check` again. 
```{r check_again}
devtools::check()
```

If everything worked, we're ready to install the package.

### Install the package as if it were on CRAN or GitHub

```{r install}
devtools::install()
```

Now you can use library!
```{r library}
library(foofactors)
```

View the documentation in the Help window just like usual:
```{r help}
?fbind
```

### Workflow Overview

While developing the package:

1. write/modify code
1. run `devtools::load_all()` to mess around with the changes you made
1. repeat

While using your package:

1. run `devtools::install(path/to/pkg)`
1. load it with `library(pkgname)`
1. use it in your analysis

## Unit Testing

Why? Automate!

Example: writing functions for inserting columns into dataframes.

```{r}
usethis::use_r("insert_into")
```

in `R/insert_into.R`:
```{r insert_into}
insert_into <- function(x, y, where = 1) {
    if (where == 1) { # first col
        cbind(y, x)
    } else if (where > ncol(x)) { # last col
        cbind(x, y)
    } else {
        lhs <- 1:(where - 1)
        cbind(x[lhs], y, x[-lhs])
    }
}
```

Manually sourcing your code and running simple test cases is tedious.

Let's write unit tests instead!

### Setup testing infrastructure

```{r use_test}
usethis::use_test("insert_into.R")
```

It created a file `tests/testthat/test-insert_into.R` with some boilerplate code to modify:
```{r}
test_that("multiplication works", {
  expect_equal(2 * 2, 4)
})
```
(You should replace this with a test that's actually useful for your code.)

Every file in `R/` should have a corresponding testfile in `tests/testthat/`.

Now whenever you run `devtools::check()`, it will also run all the unit tests.

```{r}
devtools::check()
```

#### Now let's write a useful test

in `tests/testthat/test-insert_into.R`:
```{r}
test_that("can add column at any position", {
    df1 <- data.frame(a = 3, b = 4, c = 5)
    df2 <- data.frame(X = 1, Y = 2)
    at_pos <- function(i) {
        insert_into(df1, df2, where = i)
    }

    expect_named(at_pos(1), c("X", "Y", "a", "b", "c"))
    expect_named(at_pos(2), c("a", "X", "Y", "b", "c"))
    expect_named(at_pos(3), c("a", "b", "X", "Y", "c"))
})
```

### Run the test

#### Test just one file
```{r test_file}
# with no argument, it'll assume you want to test that file you currently have open
devtools::test_file("R/insert_into.R")
```

#### Test everything without running the other checks

```{r}
devtools::test()
```
Keyboard shortcut: `Cmd + Shift + T`

### Test coverage

How well are we testing the codebase?

#### Test the coverage of a source file
```{r}
devtools::test_coverage_file("R/insert_into.R")
```

```{r}
devtools::test_coverage() 
```

#### Report test coverage with Travis CI

Have to use [Travis CI](https://travis-ci.org) for this to work (that's beyond the scope of this workshop).
```{r}
usethis::use_travis()
usethis::use_coverage()
```

Coverage builds confidence that your code does what it's supposed to do and 
guides contributors on what parts of the code need new test cases.

### Test-Driven Development 

TDD: Write the tests, then write the code.

#### Write tests for the `add_col()` function

```{r}
usethis::use_test("add_col")
```

tests in `tests/testthat/test-add_col.R`:
```{r}
test_that("where controls position", {
 df <- data.frame(x = 1)
 expect_equal(
 add_col(df, "y", 2, where = 1),
 data.frame(y = 2, x = 1)
 )
 expect_equal(
 add_col(df, "y", 2, where = 2),
 data.frame(x = 1, y = 2)
 )
}) 
```

We haven't written the function yet, so right now it fails:
```{r}
devtools::test_file("tests/testthat/test-add_col.R")
```

#### Now implement `add_col()`
